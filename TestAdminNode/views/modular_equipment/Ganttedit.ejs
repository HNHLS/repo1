<!DOCTYPE html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>Lightbox customization</title>
	<script src="/layuiadmin/layui/layui.js" type="text/javascript" charset="utf-8"></script>
	<script src="/Scripts/dhtmlxgantt.js?v=7.0.0"></script>
	<link rel="stylesheet" type="text/css" href="/layuiadmin/layui/css/layui.css" />
	<link rel="stylesheet" href="/Css/dhtmlxgantt.css?v=7.0.0">
	<script src="/Scripts/jquery-2.1.4.min.js" type="text/javascript" charset="utf-8"></script>
	<script src="/Scripts/testdata.js?v=7.0.0"></script>
	<script src="/Scripts/locale.js" type="text/javascript" charset="utf-8"></script>
	<link rel="stylesheet" href="/layer/2.4/skin/layer.css">
	<script src="/Layer/2.4/layer.js"></script>
	<script src="/moment/moment.js"></script>
	<style>
		html, body {
			height: 100%;
			padding: 0px;
			margin: 0px;
			overflow: hidden;
		}
		.gantt_btn_set.gantt_delete_btn_set{
			display: none;
		}
		.gantt_cal_light .gantt_btn_set{
			border: 1px solid #bbb;
		}
		.gantt_task_line.gantt_project{
			display: none;
		}
		.gantt_duration{
			display: none;
		}
		.gantt_message_area{
			display: none;
		}
		.small_task{
			border: 2px solid gray;
			color: gray;
			background: gray;
		}
		.i{
			color: red;
			text-align: center;
		}
		.main_text {
			color: #007aba;
		}
	</style>
</head>

<body>
<form class="layui-form" action="" style="float: left">
<div style="margin: 20px;">
	<label class="layui-form-label">只看主实验</label>
	<div class="layui-input-block">
		<input type="checkbox" id="mainFilter" lay-skin="switch" lay-filter="toggle">
	</div>
</div>
</form>
<div class="layui-btn layui-btn-sm" onclick="upload()" style="float: left; margin: 20px;"><i class="layui-icon layui-icon-shangchuan"></i>导入排程</div>
<div class="layui-btn layui-btn-sm" onclick="save()" style="float: right;margin: 20px;">保存</div>
<div class="" style="clear: right;"></div>
<div id="gantt_here" style='width:100%; height:88%;'></div>
<script>
	var subTaskNumber="<%=subTaskNumber%>"
	function save(){
		$.ajax({
			type:"get",
			url:"/modular_equipment/saveSubTaskTestPlan?subTaskNumber="+subTaskNumber,
			success:function(res){
				console.log(res)
				alert(res.message)
			}
		});
	}

		function upload(){
		   		layer.open({
					type: 2,
					title:'文件上传',
					area: ['800px', '400px'], //宽高
					content: '/modular_equipment/addfile',
				});
		   	}


	layui.use(['form'], function () {
		var form=layui.form;
		form.on('switch(toggle)',function (data) {
			toggleMainFilter(data.elem.checked);
		})
		var testCourseUseEquipmentId
		gantt.attachEvent("onBeforeLightbox", function(id) {
			var task = gantt.getTask(id);
			testCourseUseEquipmentId=task.testCourseCostDto.testCourseUseEquipmentId
			var testCourseId=task.testCourseCostDto.testCourseId
			var start_date=new Date(task.start_date);
			var Hour=start_date.getHours()
			var Minutes=start_date.getMinutes()
			console.log(start_date,Hour,Minutes,task.start_date)
			if(task.main){
				layer.open({
					type: 2,
					title:'设备余量',
					area: ['100%', '100%'],
					content: '/modular_equipment/echarts?testCourseId='+testCourseId+'&testCourseCostDto=' + encodeURIComponent(JSON.stringify(task.testCourseCostDto))+"&equipmentId="+task.equipmentId
				});
				return false;
			}else{
				layer.msg('小实验不能手动排程');
				return false
			}

		});
		gantt.plugins({
			tooltip: true
		});
		gantt.templates.tooltip_date_format = gantt.date.date_to_str("%Y-%m-%d %H:%i");
		gantt.attachEvent('onGanttReady', function () {
			gantt.templates.tooltip_text = function (start, end, task) {
				return "<b>任务:</b> " + task.text + "<br/>" +
						"<b>预计开始时间:</b> " +
						gantt.templates.tooltip_date_format(start) +
						"<br/><b>预计结束时间:</b> " + gantt.templates.tooltip_date_format(end);
			};

		});
		gantt.config.drag_links = false;
		gantt.config.drag_move = false;
		gantt.config.fit_tasks = true;
		gantt.config.drag_mode="ignore"
		gantt.config.drag_progress = false;
		gantt.config.autoscroll = true;
		gantt.config.min_column_width = 60;
		gantt.config.duration_unit = "minute";
		gantt.config.scale_height = 20 * 3;
		gantt.config.row_height = 30;
		gantt.config.date_grid = "%Y/%m/%d %H:%i";
		gantt.config.scales = [
			{unit: "month", step: 1, format: "%F, %Y"},
			{unit: "day", step: 1, format: "%D, %d"},
		];
		gantt.config.columns=[
			{name:"text",       label:"设备名称",  tree:true, width:'500',template:myTextFunc },
			{name:"start_date", label:"预计开始时间", align: "center" , width:'120',template:myStartDateFunc },
			{name:"end_date",   label:"预计结束时间",   align: "center" , width:'120',template:myEndDateFunc },
		]
		gantt.config.lightbox.sections = [
			{name:"template3", height:22, type:"template", map_to:"my_template3"},
			{name:"template", height:22, type:"template", map_to:"my_template"},
			{name:"time", height:22, type:"duration", map_to:"auto"},
			{name:"template2", height:22, type:"template", map_to:"my_template2"},
		];
		gantt.locale.labels.section_time= "预计开始时间(年月日)";
		gantt.locale.labels.section_template3 = "设备选择";
		gantt.locale.labels.section_template = "样品数量";
		gantt.locale.labels.section_template2 = "预计开始时间(时分)";
		gantt.init("gantt_here");
		gantt.templates.task_class  = function(start, end, task){
			switch (task.main){
				case true:
					return "main_task";
				case false:
					return "small_task";
			}
		};
		function myTextFunc(task) {
			if (task.main&&task.parent)
				return "<div class='main_text main_row'>" + task.text+"</div>";
			return task.text;
		}
		function myStartDateFunc(task) {
			if (task.main&&task.parent)
				return "<div class='main_text main_row'>" + moment(new Date(task.testCourseCostDto.startTime)).format("YYYY/MM/DD HH:mm")+"</div>";
			return task.start_date;
		}
		function myEndDateFunc(task) {
			if (task.main&&task.parent)
				return "<div class='main_text main_row'>" + moment(new Date(task.testCourseCostDto.completeTime)).format("YYYY/MM/DD HH:mm")+"</div>";
			return task.end_date;
		}
		gantt.templates.grid_file = function(task) {
			if (task.main && task.parent) {
				return "<div class='gantt_tree_icon'><div class='i'>主</div> </div>";
			}
			return "<div class='gantt_tree_icon gantt_file'></div>";
		};

		function querySubTaskTestPlan(subTaskNumber, filterMain) {
			filterMain = !filterMain ? false : filterMain;
				jQuery.ajax({
					type:"get",
					url:"/modular_equipment/getSubTaskTestPlan?subTaskNumber="+subTaskNumber+"&filterMain="+filterMain,
					success:function(res){
						console.log(res)
						if(res.status=="ok"){
							var data=res.message
							var obj={}
							for(var i=0;i<data.length;i++){
								if(data[i].parent){

								}else{
									data[i].type="project"
								}
							}
							obj.data=data
							console.log(obj)
							gantt.clearAll();
							gantt.parse(obj);
							gantt.render();
						}else{
							alert(res.message)
						}
					}
				});
		}

		function toggleMainFilter(checked) {
			querySubTaskTestPlan(subTaskNumber, checked);
		}

		querySubTaskTestPlan(subTaskNumber, false);
	});

</script>
</body>
	