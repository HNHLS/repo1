<!DOCTYPE html>
<html>
	<% include ../layout/header.ejs %>
	<style type="text/css">
		.blueline {
			border-bottom: 1px solid #b8ddf3;
			width: 100%;
			margin-bottom: 20px;
		}
		
		.blueline .title {
			background-color: #75bde6;
			color: white;
			padding: 6px 0px;
			width: 90px;
			text-align: center;
			font-size: 12px;
			border-radius: 8px 8px 0 0;
		}
		
		.layui-input-block {
			line-height: 36px;
		}
		
		#search {
			margin: 20px 0 20px 90px;
		}
		
		.sampling {
			/*cursor: pointer;*/
			border-radius: 6px;
			border: 1px solid #37a3dd;
		}
		
		.inStorage {
			background-color: #37a3dd;
			color: white;
		}
	</style>

	<body>
		<div class="cBody">
			<div class="layui-form-item">
				<div class="layui-input-inline">
					<input class="layui-input-block layui-input" name="search" id="search" autocomplete="off" placeholder="扫码/输入样品唯一编码" autofocus="autofocus" onkeydown="entersearch(this)">
				</div>
				<div class="layui-input-block layui-btn" style="margin-top: 20px;" id="withdrawal">退库</div>
			</div>
			<form id="addForm" class="layui-form" action="">
				<div id="jOrg">
					<div class="blueline">
						<div class="title">
							分单信息
						</div>
					</div>
					<div class="layui-form-item">
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">分单编号:</label>
							<div class="layui-input-block">
								<span name="subTaskNumber"></span>
							</div>
						</div>
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">委托编号:</label>
							<div class="layui-input-block">
								<span name="delegateNum"></span>
							</div>
						</div>
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">测试项目:</label>
							<div class="layui-input-block">
								<span name="testProj"></span>
							</div>
						</div>
					</div>
					<div class="layui-form-item">
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">样品名称:</label>
							<div class="layui-input-block">
								<span name="sampleName"></span>
							</div>
						</div>
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">样品数量:</label>
							<div class="layui-input-block">
								<span name="sampleCount"></span>
							</div>
						</div>
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">样品型号:</label>
							<div class="layui-input-block">
								<span name="sampleModel"></span>
							</div>
						</div>
					</div>
					<div class="layui-form-item">
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">样品规格:</label>
							<div class="layui-input-block">
								<span name="sampleSpecs"></span>
							</div>
						</div>
					</div>
				</div>
				<div id="jOrg">
					<div class="blueline">
						<div class="title">
							样品信息
						</div>
					</div>
					<div class="layui-form-item">
						<div class="layui-col-xs6 layui-col-sm12 layui-col-md12">
							<label class="layui-form-label">样品编号:</label>
							<div class="layui-input-block" id="sampling">
							</div>
						</div>
						<!--<div class="sampling"></div>-->
					</div>
					<div class="layui-form-item">
						<div class="layui-col-xs12">
							<label class="layui-form-label">库位编号:</label>
							<div class="layui-input-inline">
								<input type="text" class="layui-input" name="storageNum" id="storageNum">
							</div>
						</div>
					</div>
				</div>
			</form>
		</div>
	</body>
	<% include ../layout/footer.ejs %>
	<script>
		href("", "样品管理", "样品退库", "")
		var uniqueNumber = "<%=uniqueNumber%>"
		var subTaskId = parseInt("<%=subTaskId%>")
		var searchVal = $("#search").val()
		var chosen = "<%= chosen %>";
		var subTaskNumber="<%=subTaskNumber%>"
		console.log(uniqueNumber, subTaskId)
		var first = true
		if(subTaskId > 0) {
			$.ajax({
				type: "GET",
				url: "/modular_sample/getSubTaskSampleInfo?subTaskId=" + subTaskId,
				success: function(msg) {
					console.log(msg);
					var data = msg.message
					var sampleArray = data.sampleArray
					if(msg.status == "ok") {
						first = false
						$("span").each(function(i, v) {
							console.log($(v).attr("name"))
							$(v).text(data[$(v).attr("name")])
						})
						for(var i = 0; i < sampleArray.length; i++) {
							if(sampleArray[i].inStorage == "是") {

								$("#sampling").append('<div class="layui-inline sampling inStorage" style="min-width: 80px;margin-right:15px;text-align: center" title="已退库" name="' + sampleArray[i].sampleUniqueNumber + '">' + sampleArray[i].sampleNumber + '</div>')
							} else {
								$("#sampling").append('<div class="layui-inline sampling" style="min-width: 80px;margin-right:15px;text-align: center" name="' + sampleArray[i].sampleUniqueNumber + '">' + sampleArray[i].sampleNumber + '</div>')
							}
						}
						$(".sampling").each(function(i, v) {
							if($(v).attr("name") == searchVal) {
								$(v).addClass("inStorage")
								$(v).attr("title","已退库")
							}
						})
					} else {
						alert(msg.message);
					}
				}
			});
		}
		$("#withdrawal").click(function() {
			var sampleArray=[]
			$(".inStorage").each(function(i,v){
				sampleArray[i]=$(v).attr("name")
			})
			$("#search").focus()
			$.ajax({
				type: "POST",
				url: "/modular_sample/returnSampleToStorage?sampleArray=" + JSON.stringify(sampleArray) + (chosen == "理化" ? ('&subTaskNumber=' + subTaskNumber) : '') + "&storageNum=" + encodeURIComponent($("#storageNum").val()),
				data: $("#addForm").serialize(),
				success: function(msg) {
					console.log(msg);
					if(msg.status == "ok") {
						alert(msg.message);
						
						parent.location.reload()
						var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                		parent.layer.close(index);
					} else {
						alert(msg.message);
					}
				}
			});
		})
		function entersearch(obj) {
			var event = window.event || arguments.callee.caller.arguments[0];
			var searchVal = $(obj).val()
			if(event.keyCode == 13) {
				setTimeout(function() {
					$(obj).val("")
				}, 200)
				if(first) {
					$.ajax({
						type: "GET",
						url: "/modular_sample/getSubTaskSampleInfo?uniqueNumber=" + searchVal,
						success: function(msg) {
							console.log(msg);
							var data = msg.message
							var sampleArray = data.sampleArray
							subTaskNumber = searchVal;
							if(msg.status == "ok") {
								first = false
								$("span").each(function(i, v) {
									console.log($(v).attr("name"))
									$(v).text(data[$(v).attr("name")])
								})
								for(var i = 0; i < sampleArray.length; i++) {
									if (sampleArray[i].inStorage == "是") {
										if (sampleArray[i].sampleUniqueNumber == searchVal) {
											layer.msg("样品"+sampleArray[i].sampleNumber+"("+searchVal+")"+"已退库");
										}
										$("#sampling").append('<div class="layui-inline sampling inStorage" style="min-width: 80px;margin-right:15px;text-align: center" title="已退库" name="' + sampleArray[i].sampleUniqueNumber + '">' + sampleArray[i].sampleNumber + '</div>');
									} else {
										$("#sampling").append('<div class="layui-inline sampling" style="min-width: 80px;margin-right:15px;text-align: center" name="' + sampleArray[i].sampleUniqueNumber + '">' + sampleArray[i].sampleNumber + '</div>')
									}
								}

							} else {
							}
						}
					});
				} else {
					$(".sampling").each(function(i, v) {
						if($(v).attr("name") == searchVal) {
							if ($(v).hasClass("inStorage")) {
								layer.msg("样品"+$(v).attr('name')+"("+$(v).text()+")"+"已退库");
							}else{
								$(v).addClass("inStorage");
								$(v).attr("title","已退库")
							}
						}
					})
				}
			}
		}
	</script>

</html>