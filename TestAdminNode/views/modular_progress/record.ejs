<!doctype html>
<html>
<% include ../layout/header.ejs %>
<style type="text/css">
	a {
		text-decoration: none;
		color: #fff;
		font-size: 12px;
	}

	a:focus,
	a:hover {
		color: #fff;
	}

	#jOrgChart {
		margin-top: 40px;
	}

	.jOrgChart .node {
		width: 120px;
		height: 50px;
		line-height: 35px;
		border-radius: 4px;
		margin: 0 8px;
	}

	#jOrg {
		/*float: left;*/
		width: 100%;
		padding: 0px 20px;
	}

	#tab {
		width: 100%;
		/*float: right;*/
		padding: 0px 20px;
	}

	#tab>div {
		width: 100%;
	}

	.mail {
		min-height: 200px;
	}

	.blueline {
		border-bottom: 1px solid #b8ddf3;
		width: 100%;
		margin-bottom: 20px;
	}

	.blueline .title {
		background-color: #75bde6;
		color: white;
		padding: 6px 0px;
		width: 90px;
		text-align: center;
		font-size: 12px;
		border-radius: 8px 8px 0 0;
	}

	.layui-input-block {
		line-height: 36px;
	}

	/*数字框去除箭头*/
	input::-webkit-outer-spin-button,
	input::-webkit-inner-spin-button {
		-webkit-appearance: none;
	}

	input[type="number"] {
		-moz-appearance: textfield;
	}

	/*组件/层压件材料信息*/
	.layui-tab-item .layui-form-label {
		padding-top: 0px;
	}

	.synchro {
		float: right;
		height: 28px;
	}

	.sampleNum {
		display: inline-block;
	}

	.selectedsample {
		display: inline-block;
		border: 1px solid #37a3dd;
		padding: 3px 7px;
		border-radius: 5px;
		margin-left: 5px;
	}

	.blockright {
		width: 100%;
	}

	.layui-table-tips-main {
		margin: -44px 0 0 -1px;
		padding: 8px 15px;
		font-size: 14px;
		min-width: 53%;
		background-color: #fff;
		color: #666;
		height: auto;
		word-break: break-all;
	}

	.layui-layer {
		min-width: 53%;
	}
</style>

<body>
	<div class="cBody">
		<form id="addForm" class="layui-form" action="">
			<div class="toolbtn">
				<div class="layui-btn layui-btn-sm return"
					onclick="returnback('<%=page%>','<%=keyword%>','/modular_progress/project','<%=startDate%>','<%=endDate%>')">
					<i class="iconfont icon-fanhui"></i>返回列表</div>
			</div>
			<div id="task">
				<div class="sampling">
					<div class="blueline">
						<div class="title">
							样品信息
						</div>
					</div>
					<div class="layui-form-item">
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">分单号:</label>
							<div class="layui-input-block">
								<span><%=basicInfo.subTaskNumber%></span>
							</div>
						</div>
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">是否加急:</label>
							<div class="layui-input-block">
								<span><%=basicInfo.prior?'是':'否'%></span>
							</div>
						</div>
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">样品编号:</label>
							<div class="layui-input-block">
								<span><%=basicInfo.sampleNumber%></span>
							</div>
						</div>
					</div>
					<div class="layui-form-item">
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">样品名称:</label>
							<div class="layui-input-block">
								<span><%=basicInfo.sampleName%></span>
							</div>
						</div>
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">样品数量:</label>
							<div class="layui-input-block">
								<span><%=basicInfo.sampleCount%></span>
							</div>
						</div>
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">检测依据:</label>
							<div class="layui-input-block">
								<span><%=basicInfo.testStandard%></span>
							</div>
						</div>
					</div>
					<div class="layui-form-item">
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">判定依据:</label>
							<div class="layui-input-block">
								<span><%=basicInfo.judgeStandard%></span>
							</div>
						</div>
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">检测项目:</label>
							<div class="layui-input-block">
								<span><%=basicInfo.testProj%></span>
							</div>
						</div>
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">要求完成日期:</label>
							<div class="layui-input-block">
								<span><%=basicInfo.completeDateLimit%></span>
							</div>
						</div>
					</div>
					<div class="layui-form-item">
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">备注:</label>
							<div class="layui-input-block">
								<span><%=basicInfo.remark%></span>
							</div>
						</div>
					</div>
				</div>
				<div class="record">
					<div class="blueline">
						<div class="layui-inline title">
							原始记录
						</div>
						<div class="layui-inline layui-btn layui-btn-sm save" style="float: right" onclick="printiframe()"><i class="iconfont icon-baocun"></i>打印
						</div>
					</div>
					<div class="layui-form-item">
						<select name="" id="testCourseList">
							<option value=""></option>
						</select>
					</div>
					<div class="layui-form-item">
						<input type="hidden" name="json" value="<%=originalData%>">
						<iframe id="iframe" src="<%=templateUrl%>" style="width: 100%;min-height: 400px"></iframe>
					</div>
					<div class="blockright">
						<div class="demoTable" style="height: 23px;display: inline-block;"></div>

						<table class="layui-hide" id="tab1" lay-filter="tb1"></table>
					</div>
				</div>
			</div>
		</form>
	</div>
	<% include ../layout/footer.ejs %>
</body>
<script>
	href("/modular_progress/project", "进度总览", "项目管理", "原始记录")
	var testCourseId = ''
	var canPrint=false;
	layui.use(['form', 'table', 'laydate', 'jquery'], function () {
		var form = layui.form
		var table = layui.table
		var laydate = layui.laydate
		var $ = layui.jquery
			<%for (var i = 0; i < testCourseList.length; i++) {%>
				$('#testCourseList').append('<option value="' +<%=testCourseList[i].testCourseId %> +'">' + "<%=testCourseList[i].testItemName%>" + '</option>')
				<%}%>
					form.render('select')

		form.on('select', function (data) {
			//console.log(data.value);
			var text = data.elem[data.elem.selectedIndex].text;
			canPrint = !!(text && text !== '请选择' && text !== '');
			testCourseId = data.value
			$.ajax({
				type: "get",
				url: "/modular_progress/getTestCourseOriginalData?testCourseId=" + testCourseId,
				async: true,
				success: function (res) {
					//console.log(res)
					if (res.status == "ok") {
						$('#iframe').attr("src", res.message.templateUrl)
						$("input[name=json]").val(JSON.stringify(res.message.originalData))
					}
					changes(testCourseId);
					return testCourseId;
				}
			});
		})
		var $ = layui.$,
			active = {

			}

		function changes(testCourseId) {
			table.render({
				elem: '#tab1',
				url: "/modular_progress/getTestCourseOriginalData?testCourseId=" + testCourseId,
				cols: [
					[{
						field: 'accountName',
						align: 'center',
						title: '操作账号',
						width: '20%'
					}, {
						field: 'changeTime',
						align: 'center',
						title: '操作时间',
						width: '20%'
					}, {
						field: 'changeDesc',
						align: 'center',
						title: '操作描述',
						width: '60%'
					}]
				],
				response: {
					statusCode: "ok" //重新规定成功的状态码为 200，table 组件默认为 0
				},
				parseData: function (res) { //将原始数据解析成 table 组件所规定的数据
					return {
						"code": res.status, //解析接口状态
						//"msg": res.message, //解析提示文本
						//"count": res.message.total, //解析数据长度
						"data": res.message.changes //解析数据列表
					};
				},
				text: {
					none: '暂无相关数据！' //默认无数据
				},
			});
		}

		$('.layui-btn').on('click', function () {
			var type = $(this).data('type');
			active[type] ? active[type].call(this) : '';
		});
	});
	//打印
	function printiframe(iframe) {
		if (!canPrint) {
			layer.msg("请选择原始记录");
			return;
		}
		// var printWin = window.open(document.getElementById("c在").src);
		// printWin.print();
		// $("#iframe")[0].print();
		$.ajax({
			type: "get",
			url: "/modular_progress/getTestCourseOriginalData?testCourseId=" + testCourseId,
			async: true,
			success: function (res) {
				//console.log(res)
				if (res.status == "ok") {
					var myframe = document.getElementById('iframe');//获取iframe
					myframe.contentWindow.postMessage(
							{
								msg: "printPage",
								testMan:res.message.testMan,
								verifyMan:res.message.verifyMan,
								delegateNum:res.message.subTaskNumber,
								testItemName: res.message.testItemName
							},
							"<%=global.Record%>"
					);//协议+主机+端口号）
				}
			},
			fail: function () {
				layer.msg(res.message);
			}
		});

	}

</script>
<!--获取和保存原始记录-->
<script type="text/javascript">
	//新保存方式[使用中]
	//监听模块返回值
	window.addEventListener('message', function (event) {
		//console.log(event);
		if (event.data.msg === "get") {
			//通知子集传递编辑数据
			PushTChild();
		} else if (event.data.msg === 'sava') {
			//来源模版采集模块
			SaveJson(event.data.json);
		} else if (event.data.msg === 'setPrintPage') {
			console.log(event.data.json);
        }
	});


	//把编辑信息推给子级
	function PushTChild() {
		var json = $("input[name='json']").val();
		var myframe = document.getElementById('iframe');//获取iframe
		myframe.contentWindow.postMessage(
			{
				msg: "edit",
				json: json,
				type:'disabled',
			},
			"<%=global.Record%>"
		);//协议+主机+端口号）
	}

	//异步保存
	function SaveJson(json) {
		var str = JSON.stringify(json);
		$.ajax({
			type: "POST",
			url: "/modular_task/saveOriginalRecord",
			data: {
				testCourseId: testCourseId,
				json: str,
			},
			success: function (msg) {
				if (msg.status === 'ok') {
					alert("已添加!")
				} else {
					alert(msg.message);
				}
			}
		});
	}


</script>

</html>