<!DOCTYPE html>
<html>
	<% include ../layout/header.ejs %>
	<body>
		<div class="cBody">
			<div class="layui-btn-group demoTable">
			  <button class="layui-btn layui-btn-xs" data-type="addRole"><i class="layui-icon layui-icon-add-1"></i>新增</button>
			  <button class="layui-btn layui-btn-xs" data-type="delRole"><i class="layui-icon layui-icon-delete"></i>批量删除</button>
			  <button class="layui-btn layui-btn-xs" data-type="Template"><i class="layui-icon layui-icon-add-1"></i>绑定模板</button>
			  <button class="layui-btn layui-btn-xs" data-type="Import"><i class="iconfont icon-daoru1"></i>导入</button>
			  <button class="layui-btn layui-btn-xs" data-type="Export"><i class="iconfont icon-daochu1"></i>导出</button>
			</div>
			<div class="toolbar">
				<div class="layui-inline">
				    <input class="layui-input" name="search" id="search" autocomplete="off" placeholder="关键词检索" value="<%=keyword%>">
				</div>
				<button class="layui-btn layui-btn-sm" data-type="reload">搜索</button>
			</div>
			<table class="layui-hide" id="tab" lay-filter="tb"></table>
		</div>
		<shiro:hasRole name="superadmin">
			<script type="text/html" id="doit">
				<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
				<a class="layui-btn layui-btn-xs" lay-event="delete">删除</a>
			</script>
		</shiro:hasRole>
	</body>
	<% include ../layout/footer.ejs %>
	<script>
		href("","基础管理","测试项列表","")
		//角色下拉
		layui.use(['form', 'laydate','table'], function() {
			var table = layui.table;
			var form=layui.form;
			var laydate=layui.laydate;
			laydate.render({
			   elem: '#date'
			   ,range: true
			   ,trigger: 'click'
			});//日期范围
			
		// 监听工具条
		table.on('tool(tb)', function(obj) {
			var data = obj.data;
			// console.log($(obj.tr).parents(".layui-table-view").find(".layui-laypage-curr em:not(.layui-laypage-em)").text())
			var page=$(obj.tr).parents(".layui-table-view").find(".layui-laypage-curr em:not(.layui-laypage-em)").text()
			var keyword=$("#search").val()
			    //console.log(obj)
			if(obj.event === 'edit'){
			    window.location.href ='/modular_basics/testItemedit?id='+data.id+'&page='+page+'&keyword='+keyword
			}else if(obj.event === 'delete'){
				var id=[data.id]
				layer.confirm('是否删除测试项"'+data.name+'"？',function(){
					$.ajax({
						type:"post",
						url:"/modular_basics/testItemdel?ids="+JSON.stringify(id),
						async:true,
						success:function(data){
							console.log(data)
	                        if(data.status=="ok"){
	                           table.reload('tabReload', {
									page: {
										curr: 1
									},
									where: {
//										page: 1
									}
								});
	                         }
	                       layer.msg(data.message);
	                    },error:function(code){   
	                        parent.layer.msg('操作失败!',{icon: 5,time:1000});  
	                    }
					});
				})
				
			}
		});
		window.tablereload=function(page,keyword){
			table.render({
				elem: '#tab',
				url: "/modular_basics/testItemlist?keyword="+keyword,
				cellMinWidth: 10,
				even:true,
				cols: [
					[{checkbox: true},
					{
						field: 'name',
						title: '测试项名称(中文)',
						align: 'center',
					},{
						field: 'englishName',
						title: '测试项名称(英文)',
						align: 'center',
					},{
						field: 'testStandard',
						title: '检测标准名称',
						align: 'center',
					},{
						field: 'main',
						title: '主实验',
						align: 'center',
						width:'6%',
						templet:function(d){
							return d.main == 0 ? "否" : "是";
						},
					},{
						field: 'testClause',
						title: '测试条款',
						align: 'center',
					}, {
						field: 'equipment',
						align: 'center',
						title: '设备名称',
					},{
						field: 'workHour',
						align: 'center',
						title: '预估耗时(小时)',
					},{
						field: 'templateName',
						align: 'center',
						title: '绑定模板名称',
					},{
						field: 'condition',
						align: 'center',
						title: '技术要求',
					},{
						align: 'center',
						title: '操作',
						toolbar: '#doit',
					}]
				],
				id: 'tabReload',
				// page: true,
				page: {
					curr: page //重新从第 1 页开始
				},
				response: {
				statusCode: "ok" //重新规定成功的状态码为 200，table 组件默认为 0
				},
				parseData: function(res){ //将原始数据解析成 table 组件所规定的数据
				console.log(res)
				return {
					"code": res.status, //解析接口状态
					"msg": res.message, //解析提示文本
					"count": res.message.total, //解析数据长度
					"data": res.message.data //解析数据列表
				};
				},
				text: {
					none: '暂无相关数据！'//默认无数据
				},
			});
		}
		tablereload('<%=page%>','<%=keyword%>')
		// var role
		var keyword
		// form.on('select', function(data){
		// 	 console.log(data.value); //得到被选中的值]
		// 	 keyword = $('#search').val();
		// 	 role=data.value
		// 	 table.reload('tabReload', {
		//         page: {
		//           	curr: 1 //重新从第 1 页开始
		//         }
		//         ,where: {
		//           	role: role,
		//           	keyword:keyword,
		//         }
		//       });
		// });
		var ids=[]
		table.on('checkbox(tb)', function(obj) {
			ids=[]
			var checkStatus = table.checkStatus('tabReload')
		    ,data = checkStatus.data;
		    console.log(data)
		    for(var i=0;i<data.length;i++){
		      	ids[i]=data[i].id
		    }
			console.log(ids)
		});
		var $ = layui.$, active = {
		    reload: function(data){
		      keyword = $('#search').val();
			  //执行重载
			  tablereload(1,keyword)
		    //   table.reload('tabReload', {
		    //     page: {
		    //       curr: 1 //重新从第 1 页开始
		    //     }
		    //     ,where: {
		    //     	role: role,
		    //       	keyword:keyword,
		    //     }
		    //   });
		    },    
		    addRole: function(){ //获取选中数据
		      window.location.href = '/modular_basics/testItemadd'
		    },
		    Import:function(){
		    	layer.open({
		    		type:2,
		    		title:'导入标准',
		    		area:['800px', '500px'],
		    		content:'/modular_basics/ImportData'
		    	})
		    },
		    Export:function(){
		    	$.ajax({
		    		type:"POST",
		    		url:"/modular_basics/ExportData",
		    		success:function(res){
		    			console.log(res)
		    			if(res.status=="ok"){
		    				window.location.href=res.message
		    			}else{
		    				alert(res.message)
		    			}
		    			
		    		}
		    	});
		    }
		    ,delRole: function(){
		     //获取选中状态            
	            if(ids.length == 0){
	                layer.msg('批量删除至少选中一项数据',function(){});
	                return false;
	            }
				console.log(ids)
	            layer.confirm('确定要删除选中的项吗？',function(index){
	                $.ajax({
	                    type:'post',
						dataType:"json",
	                    url:"/modular_basics/testItemdel?ids="+JSON.stringify(ids),
	                    success:function(data){
							console.log(data)
	                        if(data.status=="ok"){
								ids=[]
	                           	table.reload('tabReload', {
									page: {
										curr: 1
									},
									where: {
//										page: 1
									}
								});
	                         }
	                       layer.msg(data.message);
	                    },error:function(code){   
	                        parent.layer.msg('操作失败!',{icon: 5,time:1000});  
	                    }
	                });
	            })
		   	}
		    ,Template: function(){
		     //获取选中状态            
	            if(ids.length == 0){
	                layer.msg('绑定模板至少选中一项测试项',function(){});
	                return false;
	            }
				console.log(ids)
	            layer.open({
					type: 2,
					title:"绑定模板",
					area: ['100%', '100%'],
					content: '<%=global.Template%>/TemItems/GetTem'  
				});
		   	}
		};
		$('.layui-btn').on('click', function(){
			var type = $(this).data('type');
			active[type] ? active[type].call(this) : '';
		});
		window.getTemplatenum=function(templateId,name) {
	    	alert(templateId,name)
	        layer.closeAll()
	        $.ajax({
		        type:'post',
				dataType:"json",
		        url:"/modular_basics/bindTemplate?ids="+JSON.stringify(ids)+"&templateId="+templateId+"&name="+name,
		        success:function(data){
					console.log(data)
		            if(data.status=="ok"){
						table.reload('tabReload', {
							page: {
								curr: 1
							},
							where: {
//								page: 1
							}
						});
						layer.msg(data.message);
		            }else{
						layer.msg(data.message);
					}
		       	}
		    });
	    }
	});
	
	//监听模块返回值
    window.addEventListener('message', function (event) {
        console.log(event)
        //来源报告生成模块
        getTemplatenum(event.data.id, event.data.name);
    })
    
</script>
</html>