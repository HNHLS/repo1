<!DOCTYPE html>
<html>
	<% include ../layout/header.ejs %>
	<style type="text/css">
		.blueline {
			border-bottom: 1px solid #b8ddf3;
			width: 100%;
			margin-bottom: 20px;
		}
		
		.blueline .title {
			background-color: #75bde6;
			color: white;
			padding: 6px 0px;
			width: 90px;
			text-align: center;
			font-size: 12px;
			border-radius: 8px 8px 0 0;
		}
		
		.layui-input-block {
			line-height: 36px;
		}
		
		#search {
			margin: 20px 0 20px 90px;
		}
		
		.sampling {
			cursor: pointer;
			border-radius: 6px;
			border: 1px solid #37a3dd;
		}
		
		.inStorage {
			background-color: #37a3dd;
			color: white;
		}
	</style>

	<body>
		<div class="cBody">
			<form id="addForm" class="layui-form" action="">
				<div class="layui-inline">
					
				</div>
				<div class="layui-inline">
					
				</div>
				<div id="jOrg">
					<div class="blueline">
						<div class="title">
							分单信息
						</div>
					</div>
					<div class="layui-form-item">
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">分单编号:</label>
							<div class="layui-input-block">
								<span name="subTaskNumber"></span>
							</div>
						</div>
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">委托编号:</label>
							<div class="layui-input-block">
								<span name="delegateNum"></span>
							</div>
						</div>
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">测试项目:</label>
							<div class="layui-input-block">
								<span name="testProj"></span>
							</div>
						</div>
					</div>
					<div class="layui-form-item">
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">样品名称:</label>
							<div class="layui-input-block">
								<span name="sampleName"></span>
							</div>
						</div>
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">样品数量:</label>
							<div class="layui-input-block">
								<span name="sampleCount"></span>
							</div>
						</div>
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">样品型号:</label>
							<div class="layui-input-block">
								<span name="sampleModel"></span>
							</div>
						</div>
					</div>
					<div class="layui-form-item">
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">样品规格:</label>
							<div class="layui-input-block">
								<span name="sampleSpecs"></span>
							</div>
						</div>
					</div>
				</div>
				<div id="jOrg">
					<div class="blueline">
						<div class="title">
							样品信息
						</div>
					</div>
					<div class="layui-form-item">
						<div class="layui-col-xs6 layui-col-sm12 layui-col-md12">
							<label class="layui-form-label">样品编号:</label>
							<div class="layui-input-block" id="sampling">
							</div>
						</div>
						<!--<div class="sampling"></div>-->
					</div>
					<div class="layui-form-item">
						<div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
							<label class="layui-form-label">异常备注:</label>
							<div class="layui-input-block">
								<textarea type="text" class="layui-textarea" name="extra" id="extra" style="resize: none;min-height: 70px !important;"></textarea>
							</div>
						</div>
					</div>

				</div>
			</form>
			<div class="layui-form-item" style="margin-top: 100px;">
				<div class="layui-inline" style="position: relative;left: 45%;">
					<div class="layui-btn" id="receive">确认</div>
				</div>
			</div>
		</div>
	</body>
	<% include ../layout/footer.ejs %>
	<script>
		href("", "样品管理", "样品退库", "")
		var uniqueNumber = "<%=uniqueNumber%>"
		var subTaskNumber = "<%=subTaskNumber%>"
		console.log(uniqueNumber, subTaskNumber)
		layui.use(['form', 'jquery','table'], function() {
			var $=layui.jquery
			var form=layui.form
			$.ajax({
				type: "GET",
				url: "/modular_task/getSubTaskSampleInfo?subTaskNumber=" + subTaskNumber,
				success: function(msg) {
					console.log(msg);
					var data = msg.message
					var sampleArray = data.sampleArray
					if(msg.status == "ok") {
						$("span").each(function(i, v) {
							$(v).text(data[$(v).attr("name")])
						})
						for(var i = 0; i < sampleArray.length; i++) {
							$("#sampling").append('<div class="am-inline-block sampling" style="min-width: 80px;margin-right:15px;text-align: center" onclick="sampling(this)" name="' + sampleArray[i].sampleUniqueNumber + '">' + sampleArray[i].sampleNumber + '</div>')
						}
					} else {
						alert(msg.message);
					}
				}
			});
			window.sampling=function(obj){
				if($(obj).hasClass("inStorage")){
					$(obj).removeClass("inStorage")
				}else{
					$(obj).addClass("inStorage")
				}
			}
		})
		$("#receive").click(function() {
			var sampleArray=[]
			var extra=$("#extra").val()
			console.log(extra)
			$(".inStorage").each(function(i,v){
				sampleArray[i]=$(v).attr("name")
			})
			$.ajax({
				type: "POST",
				url: "/modular_task/notifySampleProblem?sampleArray=" +JSON.stringify(sampleArray)+"&extra="+extra+"&subTaskNumber="+subTaskNumber,
				data: $("#addForm").serialize(),
				success: function(msg) {
					console.log(msg);
					if(msg.status == "ok") {
//						alert(msg.message);
						parent.layer.msg(msg.message)
						parent.location.reload()
						var index = parent.layer.getFrameIndex(window.name); //获取窗口索引
                		parent.layer.close(index);
					} else {
						alert(msg.message);
					}
				}
			});
		})
		
	</script>

</html>